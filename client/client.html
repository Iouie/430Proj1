<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>YGO Card Generator</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

    //function to handle our response
      const handleResponse = (xhr, parseResponse) => {
        //update client
      const content = document.querySelector('#content');
      
      //check the status code
      switch(xhr.status) {
        case 200: //success
          content.innerHTML = `<h2>Cards Created</h2>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Created A Card</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Card Updated</b>';
          return;
        case 400: //bad request
          content.innerHTML = `<b>You're missing information</b>`;
          break;
          case 404: //bad request
          content.innerHTML = `<b>Resource Not Found</b>`;
          break;
        default: //any other status code
          break;
      }

      // parse response
      if(parseResponse){
        const obj = JSON.parse(xhr.response);
        console.dir(obj.message);
        if(xhr.status === 200){
        if(obj.message.cards){
        for(let key in obj.message.cards){
          if(obj.message.cards.hasOwnProperty(key)){
            const div = document.createElement('div');   // create div
            const img = document.createElement('img');   // img
            const name = document.createElement('h3');   // card name
            const cType = document.createElement('p');   // card type
            const descript = document.createElement('p'); // description

            name.innerHTML = obj.message.cards[key].name;
            cType.innerHTML = obj.message.cards[key].cardType;
            descript.innerHTML = obj.message.cards[key].description;

            img.setAttribute('src', obj.message.cards[key].imgUrl);
            img.setAttribute('class', 'cardImg');
            name.setAttribute('class', 'cardTitle');
            div.setAttribute('class', 'ygoCard');
            
            div.appendChild(img);
            div.appendChild(name);
            div.appendChild(cType);
            div.appendChild(descript);
            content.appendChild(div);
          }
        }
      }
    }
        else{
            content.innerHTML += `<p> ${obj.message} </p>`;
      }
    }
  };


    const sendPost = (url, type, e) => {

      const xhr = new XMLHttpRequest();
      xhr.open(type, url);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('Accept', 'application/json');

      xhr.onload = () => {
        if (type === 'get' || (type === 'post' && xhr.status === 204)){
          handleResponse(xhr, true);
        }
        else if(type === 'head' || (type === 'post' && xhr.status === 204)){
          handleResponse(xhr, false);
        }
      };

      if(type === 'post'){
      const nameForm = document.querySelector('#cardForm');
      const nameField = nameForm.querySelector('#nameField');
      const cType = nameForm.querySelector('#cType');
      const description = nameForm.querySelector('#descriptionField');
      const imgUrl = nameForm.querySelector('#urlField');


      const formData = `name=${nameField.value}&cardType=${cType.value}&description=${description.value}&imgUrl=${imgUrl.value}`;
      
      xhr.send(formData);

      return false;
      }
      else{
        xhr.send();
      }
    };


    const init = () => {
      const cardForm = document.querySelector('#cardForm');
      const postCard = cardForm.querySelectorAll('input')[2];

      postCard.addEventListener('click', e => {
        e.preventDefault();
        sendPost('/addCard', 'post', e);
      });

      const actionForm = document.querySelector('#actionForm');
      const getCards = actionForm.querySelector('input');

      getCards.addEventListener('click', e =>{
        e.preventDefault();
        sendPost('/getCards', 'get', e);
      });

    }
    window.onload = sendPost('/getCards', 'get');
    window.onload = init;
</script>
</head>

<body>
  <div id="header">
    <h1 id='title'>YGO Card Generator</h1>
    <p>All these new Yu Gi Oh cards are wack.</p>
    <p>Make your own card and check out all the cards you have created instead!</p>
  </div>

  <form id="cardForm">

    <label for="name">Card Name: </label>
    <input id="nameField" type="text" name="name" class="textField" /><br>

    <label for="cardType">Card Type:</label>
    <select id="cType" name="cardType">

      <option value="monster">Monster</option>
      <option value="spell">Spell</option>
      <option value="trap">Trap</option>

    </select><br>

    <label for="description">Description/Effect:</label>
    <textarea id="descriptionField" type="text" name="description" rows="5" cols="50" class="textField"></textarea><br>

    <label for="imgUrl">Image:</label>
    <input id="urlField" type="text" name="imgUrl" /><br>

    <div id='addCard'>
      <input type='submit' value='Add Card'/>
    </div>
  </form>

  <form id='actionForm' action='/getCards' method='get'>
    <div id='refresh'>
      <input type='submit' value='Get Cards' />
    </div>
  </form>

  <section id="content">
  </section>
</body>

</html>